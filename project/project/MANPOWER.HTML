<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>MANPOWER DASHBOARD ‚Äî Date & 15-Day Sample</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body { background: #f6f8fb; }
      .highlight {
        color: #e60000;
        font-weight: 700;
        animation: glow 1.5s infinite alternate;
      }
      @keyframes glow {
        from {
          text-shadow: 0 0 4px rgba(230, 0, 0, 0.25),
            0 0 8px rgba(230, 0, 0, 0.15);
        }
        to {
          text-shadow: 0 0 14px rgba(230, 0, 0, 0.6),
            0 0 26px rgba(230, 0, 0, 0.35);
        }
      }

      /* details panel animation */
      #absentDetailsDiv {
        opacity: 0;
        visibility: hidden;
        transform: translateY(18px);
        transition: opacity 0.45s ease, transform 0.45s ease,
          visibility 0.45s ease;
      }
      #absentDetailsDiv.show {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }

      .hoverable:hover { background-color: #eef6ff; cursor: pointer; }
      .table th, .table td { vertical-align: middle; }
      .topbar { display:flex; justify-content:space-between; align-items:center; gap:10px; }
      .date-controls { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
      .small-muted { font-size:0.85rem; color:#555; }
      @media (max-width: 767px) {
        .topbar { flex-direction:column; align-items:flex-start; gap:6px; }
      }
    </style>
  </head>
  <body class="p-3">
    <div class="container-fluid">
      <!-- Header -->
      <div class="row mb-3">
        <div class="col-12">
          <div class="card shadow-sm border-dark">
            <div class="card-body">
              <div class="topbar">
                <div>
                  <h4 class="mb-0"> FINAL TOTAL OF MANPOWER - HQ 330 INF BDE</h4>
                  <div class="small-muted"></div>
                </div>

                <div style="text-align:right">
                  <div id="currentDayDate" class="fw-bold"></div>
                  <div id="currentTime" class="small-muted"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div> <!-- /header -->

      <!-- Date controls -->
      <div class="row mb-3">
        <div class="col-12">
          <div class="card shadow-sm border-dark">
            <div class="card-body d-flex justify-content-between align-items-center flex-wrap">
              <div class="date-controls">
                <label class="me-2 fw-semibold">Select Date:</label>
                <select id="dateSelect" class="form-select form-select-sm" style="width:220px"></select>
                <input id="datePicker" type="date" class="form-control form-control-sm" style="width:170px" />
                <button id="todayBtn" class="btn btn-sm btn-outline-primary">Today</button>
                <div class="small-muted ms-3">Tip: use dropdown for last 15 days or calendar to pick any date.</div>
              </div>

              <div class="small-muted">
                
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Tables -->
      <div class="row g-3">
        <div class="col-lg-6">
          <div class="card border-dark shadow-sm">
            <div class="card-header bg-success text-white fw-bold text-center border-dark">
              PRESENT STRENGTH
            </div>
            <div class="card-body p-2">
              <table id="presentTable" class="table table-bordered border-dark text-center mb-0">
                <thead class="table-success">
                  <tr><th style="min-width:180px">Unit</th><th>Offrs</th><th>JCOs</th><th>ORs</th><th>Total</th></tr>
                </thead>
                <tbody id="presentBody"></tbody>
                <tfoot class="table-info fw-bold">
                  <tr><td>GRAND TOTAL</td><td id="presentGtOffrs">0</td><td id="presentGtJcos">0</td><td id="presentGtOrs">0</td><td id="presentGtTotal">0</td></tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>

        <div class="col-lg-6">
          <div class="card border-dark shadow-sm">
            <div class="card-header bg-danger text-white fw-bold text-center border-dark">
              ABSENT STRENGTH
            </div>
            <div class="card-body p-2">
              <table id="absentTable" class="table table-bordered border-dark text-center mb-0">
                <thead class="table-danger">
                  <tr><th style="min-width:180px">Unit</th><th>Offrs</th><th>JCOs</th><th>ORs</th><th>Total</th></tr>
                </thead>
                <tbody id="absentBody"></tbody>
                <tfoot class="table-info fw-bold">
                  <tr><td>GRAND TOTAL</td><td id="absentGtOffrs">0</td><td id="absentGtJcos">0</td><td id="absentGtOrs">0</td><td id="absentGtTotal">0</td></tr>
                </tfoot>
              </table>
              <div class="small-muted mt-2">Hover or click a unit row to view that unit's absent names for the selected date.</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Details + Print/CSV -->
      <div id="absentDetailsDiv" class="card border-dark shadow-sm mt-3">
        <div class="card-header bg-warning text-dark fw-bold d-flex justify-content-between align-items-center" id="detailsTitle">
          <span>ABSENT PERSONNEL DETAILS</span>
          <div>
            <button id="exportCSVBtn" class="btn btn-sm btn-outline-dark me-2">üñ®Ô∏è Print / CSV</button>
            <button id="pinBtn" class="btn btn-sm btn-outline-dark me-2">Pin</button>
            <button id="closeDetailsBtn" class="btn btn-sm btn-outline-dark">Close</button>
          </div>
        </div>
        <div class="card-body p-2">
          <table class="table table-bordered border-dark text-center mb-0">
            <thead class="table-warning"><tr><th>Rank</th><th>Name</th><th>Appointment</th><th>Reason</th></tr></thead>
            <tbody id="detailsBody"></tbody>
          </table>
        </div>
      </div>

    </div>

    <script>
      /* ======= Configuration & base data ======= */
      const units = [
        "15 Maratha LI", "13 Mahar", "15 Jat", "330 BDE CAMP", "330 IBSC", "257 FD WKSP"
      ];

      // Base total strength (used as baseline for each date)
      const baseTotals = {
        "15 Maratha LI": { offrs: 12, jcos: 25, ors: 520 },
        "13 Mahar": { offrs: 10, jcos: 22, ors: 510 },
        "15 Jat": { offrs: 11, jcos: 24, ors: 495 },
        "330 BDE CAMP": { offrs: 8, jcos: 12, ors: 110 },
        "330 IBSC": { offrs: 6, jcos: 10, ors: 90 },
        "257 FD WKSP": { offrs: 7, jcos: 15, ors: 130 },
      };

      const highlightAppointments = ["CHM","BHM","CQMH","SR JCO","PL HAV","PL CDR","COY CDR","SEC CDR"];

      // DOM refs
      const presentBody = document.getElementById("presentBody");
      const absentBody = document.getElementById("absentBody");
      const detailsDiv = document.getElementById("absentDetailsDiv");
      const detailsBody = document.getElementById("detailsBody");
      const detailsTitle = document.getElementById("detailsTitle");
      const exportBtn = document.getElementById("exportCSVBtn");
      const pinBtn = document.getElementById("pinBtn");
      const closeBtn = document.getElementById("closeDetailsBtn");
      const dateSelect = document.getElementById("dateSelect");
      const datePicker = document.getElementById("datePicker");
      const todayBtn = document.getElementById("todayBtn");
      const currentDayDateEl = document.getElementById("currentDayDate");
      const currentTimeEl = document.getElementById("currentTime");

      let sampleData = {}; // maps YYYY-MM-DD -> absentPersonnel object
      let selectedDateKey = null;
      let currentUnit = null;
      let pinned = false;

      /* ======= Helpers: date formatting ======= */
      function toDateKey(d) { // YYYY-MM-DD
        const y = d.getFullYear();
        const m = String(d.getMonth()+1).padStart(2,'0');
        const day = String(d.getDate()).padStart(2,'0');
        return `${y}-${m}-${day}`;
      }
      function formatDisplay(d) { // e.g. Mon 27 Oct 2025
        const opts = { weekday:'short', day:'2-digit', month:'short', year:'numeric' };
        return d.toLocaleDateString('en-GB', opts);
      }

      /* ======= Generate sample data for last 15 days ======= */
      function generateSampleData() {
        sampleData = {};
        const today = new Date();
        for (let i=0;i<15;i++) {
          const d = new Date(today);
          d.setDate(today.getDate() - i);
          const key = toDateKey(d);
          // clone base absent personnel and vary randomly
          const absentPersonnel = {};
          units.forEach(u => {
            // create a variable number of absent people for that unit (0 .. up to ~8)
            const maxPossible = Math.min(12, Math.floor(baseTotals[u].ors * 0.05) + 6);
            const count = Math.max(0, Math.floor(Math.abs(Math.sin((i+u.length)*13))* (maxPossible)) );
            const arr = [];
            // make sure some days have zero absent, some more
            const seedCount = Math.max(0, (i + u.length) % (Math.max(2, Math.floor(maxPossible/2)+1)));
            const totalCount = Math.max(count, seedCount);
            const namesPool = generateNamePool(u);
            for (let k=0;k<totalCount;k++) {
              // pick category distribution roughly: 5% offrs, 15% jcos, rest ors
              const r = Math.random();
              let category = 'or';
              if (r < 0.06) category = 'offr';
              else if (r < 0.22) category = 'jco';
              // pick name & rank from pool
              const p = namesPool[k % namesPool.length];
              // assign appointment occasionally
              const appts = ["Rifleman","Driver","Cook","MG","Fitter","Medic"];
              const mainAppts = ["CHM","BHM","CQMH","SR JCO","PL HAV","PL CDR","COY CDR","SEC CDR"];
              const pickMain = Math.random() < 0.12; // 12% chance it's a main appt
              const appt = pickMain ? mainAppts[Math.floor(Math.random()*mainAppts.length)] : appts[Math.floor(Math.random()*appts.length)];
              const reason = Math.random() < 0.5 ? "Leave" : (Math.random() < 0.5 ? "TD" : "Medical");
              arr.push({ category, rank: p.rank, name: `${p.name} (${key.slice(-2)})`, appt, reason });
            }
            absentPersonnel[u] = arr;
          });
          sampleData[key] = absentPersonnel;
        }
      }

      // simple name pool generator per unit
      function generateNamePool(unit) {
        // stable seed per unit for reproducibility
        const baseNames = {
          "15 Maratha LI": ["Deshmukh","Patil","Kale","Pawar","Shinde","More","Gaikwad","Kulkarni","Rane","Nandre"],
          "13 Mahar": ["Shewale","Kadam","Dahiwal","Nikam","Sutar","Gade","Jadhav","Patwardhan","Dhoble","Mali"],
          "15 Jat": ["Singh","Kumar","Rana","Yadav","Bisht","Chaudhary","Gautam","Verma","Kohli","Chopra"],
          "330 BDE CAMP": ["Yadav","Rawat","Shaikh","Raut","Salunkhe","Mane","Ghosh","Iyer","Saxena","Rao"],
          "330 IBSC": ["Sharma","Singh","Joshi","Patel","Shukla","Kumar","Pandey","Sinha","Bose","Thakur"],
          "257 FD WKSP": ["Tambe","Jadhav","Gore","Patel","Khandekar","Desai","Shetty","D'souza","Fernandes","Naik"]
        };
        const ranks = ["Maj","Capt","Lt","Sub","Nb Sub","Hav","L/Cpl","Pte"];
        const list = [];
        const names = baseNames[unit] || ["Ram","Shyam","Aman","Vikram","Raj"];
        for (let i=0;i<20;i++) {
          list.push({ rank: ranks[i % ranks.length], name: `${names[i % names.length]}${i+1}` });
        }
        return list;
      }

      /* ======= UI population: fill date controls (last 15 days) ======= */
      function populateDateControls() {
        dateSelect.innerHTML = "";
        const today = new Date();
        for (let i=0;i<15;i++) {
          const d = new Date(today);
          d.setDate(today.getDate() - i);
          const key = toDateKey(d);
          const opt = document.createElement('option');
          opt.value = key;
          opt.textContent = `${formatDisplay(d)} (${key})`;
          dateSelect.appendChild(opt);
        }
        // default select today
        dateSelect.selectedIndex = 0;
        datePicker.value = toDateKey(new Date());
        selectedDateKey = dateSelect.value;
      }

      /* ======= Render tables for currently selectedDateKey ======= */
      function computeAbsentCountsForDate(dateKey) {
        const absentPersonnelForDate = sampleData[dateKey] || {};
        const summary = {};
        units.forEach(u => {
          summary[u] = { offrs:0, jcos:0, ors:0, total:0 };
          const arr = absentPersonnelForDate[u] || [];
          arr.forEach(p => {
            const cat = (p.category || '').toLowerCase();
            if (cat === 'offr') summary[u].offrs++;
            else if (cat === 'jco') summary[u].jcos++;
            else summary[u].ors++;
          });
          summary[u].total = summary[u].offrs + summary[u].jcos + summary[u].ors;
        });
        return summary;
      }

      function renderTablesForDate(dateKey) {
        const absentCounts = computeAbsentCountsForDate(dateKey);
        presentBody.innerHTML = '';
        absentBody.innerHTML = '';

        let pOff=0,pJ=0,pR=0,aOff=0,aJ=0,aR=0;
        units.forEach(u => {
          const base = baseTotals[u];
          const abs = absentCounts[u] || {offrs:0,jcos:0,ors:0,total:0};
          const pres = {
            offrs: Math.max(0, base.offrs - abs.offrs),
            jcos: Math.max(0, base.jcos - abs.jcos),
            ors: Math.max(0, base.ors - abs.ors)
          };
          const presTotal = pres.offrs + pres.jcos + pres.ors;
          presentBody.insertAdjacentHTML('beforeend', `<tr><td class="text-start">${u}</td><td>${pres.offrs}</td><td>${pres.jcos}</td><td>${pres.ors}</td><td>${presTotal}</td></tr>`);
          absentBody.insertAdjacentHTML('beforeend', `<tr class="hoverable" data-unit="${u}" data-date="${dateKey}"><td class="text-start">${u}</td><td>${abs.offrs}</td><td>${abs.jcos}</td><td>${abs.ors}</td><td>${abs.total}</td></tr>`);
          pOff += pres.offrs; pJ += pres.jcos; pR += pres.ors;
          aOff += abs.offrs; aJ += abs.jcos; aR += abs.ors;
        });

        document.getElementById("presentGtOffrs").textContent = pOff;
        document.getElementById("presentGtJcos").textContent = pJ;
        document.getElementById("presentGtOrs").textContent = pR;
        document.getElementById("presentGtTotal").textContent = pOff + pJ + pR;

        document.getElementById("absentGtOffrs").textContent = aOff;
        document.getElementById("absentGtJcos").textContent = aJ;
        document.getElementById("absentGtOrs").textContent = aR;
        document.getElementById("absentGtTotal").textContent = aOff + aJ + aR;

        attachRowEvents();
      }

      /* ======= attach events for absent rows (hover/click) ======= */
      function attachRowEvents() {
        document.querySelectorAll("#absentBody tr").forEach(row => {
          const unit = row.dataset.unit;
          const dateKey = row.dataset.date;
          row.addEventListener('mouseenter', () => { if (!pinned) showUnitDetailsForDate(unit, dateKey); });
          row.addEventListener('mouseleave', () => { if (!pinned) hideDetails(); });
          row.addEventListener('click', () => { pinned = true; pinBtn.textContent = 'Pinned ‚úì'; showUnitDetailsForDate(unit, dateKey); });
        });
      }

      function showUnitDetailsForDate(unit, dateKey) {
        currentUnit = unit;
        const list = (sampleData[dateKey] && sampleData[dateKey][unit]) ? sampleData[dateKey][unit] : [];
        detailsBody.innerHTML = '';
        if (list.length === 0) {
          detailsBody.insertAdjacentHTML('beforeend', `<tr><td colspan="4">No absent personnel recorded for ${unit} on ${dateKey}.</td></tr>`);
        } else {
          list.forEach(p => {
            const isHigh = highlightAppointments.includes((p.appt || '').toUpperCase());
            detailsBody.insertAdjacentHTML('beforeend', `<tr class="${isHigh ? 'highlight' : ''}"><td>${p.rank}</td><td class="text-start">${p.name}</td><td>${p.appt}</td><td>${p.reason}</td></tr>`);
          });
        }
        detailsTitle.querySelector('span').textContent = `${unit} ‚Äì Absent Personnel (${list.length}) ‚Äî ${dateKey}`;
        detailsDiv.classList.add('show');
      }

      function hideDetails() {
        detailsDiv.classList.remove('show');
        if (!pinned) { currentUnit = null; }
      }

      /* ======= Export / Print behavior (use currentUnit & selectedDateKey) ======= */
      exportBtn.addEventListener('click', () => {
        if (!currentUnit) { alert('Select a unit first (hover or click).'); return; }
        const choice = confirm("Press OK to Download CSV\nPress Cancel to Print Report");
        if (choice) exportCSV(currentUnit, selectedDateKey);
        else printReport(currentUnit, selectedDateKey);
      });

      pinBtn.addEventListener('click', () => {
        pinned = !pinned;
        pinBtn.textContent = pinned ? 'Pinned ‚úì' : 'Pin';
      });

      closeBtn.addEventListener('click', () => {
        detailsDiv.classList.remove('show');
        pinned = false;
        pinBtn.textContent = 'Pin';
        currentUnit = null;
      });

      function exportCSV(unit, dateKey) {
        const list = (sampleData[dateKey] && sampleData[dateKey][unit]) ? sampleData[dateKey][unit] : [];
        if (!list.length) return alert('No data to export for ' + unit + ' on ' + dateKey);
        let csv = 'Rank,Name,Appointment,Reason,Category,Date,Unit\n';
        list.forEach(p => {
          csv += `${p.rank},${p.name},${p.appt},${p.reason},${p.category},${dateKey},${unit}\n`;
        });
        const blob = new Blob([csv], { type:'text/csv' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `${unit.replace(/ /g,'_')}_${dateKey}_Absent.csv`;
        link.click();
      }

      function printReport(unit, dateKey) {
        const list = (sampleData[dateKey] && sampleData[dateKey][unit]) ? sampleData[dateKey][unit] : [];
        if (!list.length) return alert('No data to print for ' + unit + ' on ' + dateKey);
        const newWin = window.open('', '_blank');
        newWin.document.write(`<html><head><title>${unit} Absent Report ${dateKey}</title>
          <style>body{font-family:Arial;padding:20px}h3{text-align:center}table{border-collapse:collapse;width:100%}th,td{border:1px solid #333;padding:8px;text-align:center}th{background:#f8d775} .highlight{color:#e60000;font-weight:bold}</style>
        </head><body>`);
        newWin.document.write(`<h3>${unit} ‚Äì Absent Report ‚Äî ${dateKey}</h3>`);
        newWin.document.write(`<table><tr><th>Rank</th><th>Name</th><th>Appointment</th><th>Reason</th></tr>`);
        list.forEach(p => {
          const isHigh = highlightAppointments.includes((p.appt||'').toUpperCase());
          newWin.document.write(`<tr class="${isHigh? 'highlight':''}"><td>${p.rank}</td><td>${p.name}</td><td>${p.appt}</td><td>${p.reason}</td></tr>`);
        });
        newWin.document.write(`</table></body></html>`);
        newWin.document.close();
        newWin.print();
      }

      /* ======= Date control handlers ======= */
      dateSelect.addEventListener('change', (e) => {
        selectedDateKey = e.target.value;
        datePicker.value = selectedDateKey;
        renderTablesForDate(selectedDateKey);
      });

      datePicker.addEventListener('change', (e) => {
        selectedDateKey = e.target.value;
        // if selected date is within sampleData range, set dropdown to that, otherwise leave dropdown
        const opts = [...dateSelect.options];
        const idx = opts.findIndex(o => o.value === selectedDateKey);
        if (idx >= 0) dateSelect.selectedIndex = idx;
        renderTablesForDate(selectedDateKey);
      });

      todayBtn.addEventListener('click', () => {
        const k = toDateKey(new Date());
        selectedDateKey = k;
        datePicker.value = k;
        const opts = [...dateSelect.options];
        const idx = opts.findIndex(o => o.value === selectedDateKey);
        if (idx >= 0) dateSelect.selectedIndex = idx;
        renderTablesForDate(selectedDateKey);
      });

      /* ======= Current date/time display ======= */
      function updateClock() {
        const now = new Date();
        const dayOpts = { weekday:'long', day:'2-digit', month:'short', year:'numeric' };
        currentDayDateEl.textContent = now.toLocaleDateString('en-GB', dayOpts);
        const timeStr = now.toLocaleTimeString('en-GB');
        currentTimeEl.textContent = timeStr;
      }
      setInterval(updateClock, 1000);
      updateClock();

      /* ======= Initialization: generate sampleData, populate controls, render initial day ======= */
      generateSampleData();
      populateDateControls();
      selectedDateKey = dateSelect.value;
      datePicker.value = selectedDateKey;
      renderTablesForDate(selectedDateKey);

      /* ======= Utility: expose functions to add/remove absent entries at runtime if needed ======= */
      window.addAbsentForDate = function(dateKey, unit, person) {
        if (!sampleData[dateKey]) sampleData[dateKey] = {};
        if (!sampleData[dateKey][unit]) sampleData[dateKey][unit] = [];
        sampleData[dateKey][unit].push(person);
        if (dateKey === selectedDateKey) renderTablesForDate(dateKey);
      };
      window.removeAbsentByNameForDate = function(dateKey, unit, name) {
        if (!sampleData[dateKey] || !sampleData[dateKey][unit]) return;
        sampleData[dateKey][unit] = sampleData[dateKey][unit].filter(p => p.name !== name);
        if (dateKey === selectedDateKey) renderTablesForDate(dateKey);
      };
    </script>
  </body>
</html>
